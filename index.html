<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Excel Project Manager</title>
    <!-- 1. Include Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; height: 100vh; margin: 0; }
        
        #chat-container { width: 90%; max-width: 600px; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 10px; display: flex; flex-direction: column; overflow: hidden; height: 90vh; margin-top: 20px; }
        
        #chat-header { background: #007bff; color: white; padding: 15px; text-align: center; font-weight: bold; }
        
        #chat-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        .message { max-width: 80%; padding: 10px 15px; border-radius: 15px; line-height: 1.4; font-size: 14px; }
        .user-message { align-self: flex-end; background-color: #007bff; color: white; border-bottom-right-radius: 2px; }
        .bot-message { align-self: flex-start; background-color: #e9ecef; color: #333; border-bottom-left-radius: 2px; }
        
        /* Style for the Chart Container inside chat */
        .chart-container {
            width: 100%;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
        }

        #input-area { display: flex; padding: 15px; border-top: 1px solid #ddd; background: #fff; }
        input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; outline: none; }
        button { margin-left: 10px; padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; }
    </style>
</head>
<body>

<div id="chat-container">
    <div id="chat-header">ðŸ“Š Project Plan AI Assistant</div>
    <div id="chat-box">
        <div class="message bot-message">Hello! I've loaded your Excel Project Plan. Ask me about tasks, dates, or ask for a graph!</div>
    </div>
    <div id="input-area">
        <input type="text" id="user-input" placeholder="E.g., Graph the duration of tasks..." onkeypress="handleEnter(event)">
        <button onclick="sendMessage()" id="send-btn">Send</button>
    </div>
</div>

<script>
    // ðŸ”´ REPLACE THIS WITH YOUR RENDER URL
    const API_URL = "https://aiproject-1-ipxt.onrender.com";

    function handleEnter(event) {
        if (event.key === "Enter") sendMessage();
    }

    async function sendMessage() {
        const inputField = document.getElementById("user-input");
        const sendBtn = document.getElementById("send-btn");
        const chatBox = document.getElementById("chat-box");
        const prompt = inputField.value.trim();

        if (!prompt) return;

        // 1. Add User Message
        appendMessage(prompt, "user-message");
        inputField.value = "";
        inputField.disabled = true;
        sendBtn.disabled = true;

        // Add loading text
        const loadingId = "loading-" + Date.now();
        appendMessage("Analyzing data...", "bot-message", loadingId);

        try {
            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt: prompt })
            });

            const data = await response.json();
            
            // Remove loading message
            document.getElementById(loadingId).remove();

            // 2. Handle Response Type
            if (data.status === "error") {
                appendMessage("Error: " + data.response, "bot-message");
            } 
            else if (data.type === "chart") {
                // A. Show the summary text
                appendMessage(data.response, "bot-message");
                
                // B. Render the Chart
                renderChart(data.chart_data);
            } 
            else {
                // Normal Text Response
                appendMessage(data.response, "bot-message");
            }

        } catch (error) {
            document.getElementById(loadingId).remove();
            appendMessage("Connection error. Is the server running?", "bot-message");
            console.error(error);
        } finally {
            inputField.disabled = false;
            sendBtn.disabled = false;
            inputField.focus();
        }
    }

    function appendMessage(text, className, id = null) {
        const chatBox = document.getElementById("chat-box");
        const msgDiv = document.createElement("div");
        msgDiv.className = `message ${className}`;
        msgDiv.innerText = text;
        if (id) msgDiv.id = id;
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // ðŸ“Š FUNCTION TO DRAW THE CHART
    function renderChart(chartData) {
        const chatBox = document.getElementById("chat-box");
        
        // 1. Create a container for the chart
        const container = document.createElement("div");
        container.className = "chart-container";
        
        // 2. Create the Canvas element
        const canvas = document.createElement("canvas");
        // Generate a unique ID so we don't overwrite previous charts
        const uniqueId = "chart-" + Date.now(); 
        canvas.id = uniqueId;
        
        container.appendChild(canvas);
        chatBox.appendChild(container);

        // 3. Initialize Chart.js
        const ctx = document.getElementById(uniqueId).getContext('2d');
        
        new Chart(ctx, {
            type: chartData.chart_type, // 'bar', 'line', or 'pie'
            data: {
                labels: chartData.data.labels, // ["Task A", "Task B"]
                datasets: [{
                    label: chartData.title,
                    data: chartData.data.values, // [10, 20]
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(255, 206, 86, 0.6)',
                        'rgba(75, 192, 192, 0.6)',
                        'rgba(153, 102, 255, 0.6)'
                    ],
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
        
        // Scroll to show the new chart
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

</body>
</html>
