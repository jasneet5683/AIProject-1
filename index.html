<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jasneet AI Assistant</title>
    
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 700px; /* Made slightly wider for tables */
            padding: 30px;
            display: flex;
            flex-direction: column;
            height: 90vh; /* Fixed height for better scrolling */
        }
        
        h1 { text-align: center; color: #333; margin-bottom: 10px; font-size: 24px; }
        
        .status-bar { padding: 8px; border-radius: 6px; margin-bottom: 15px; text-align: center; font-size: 13px; font-weight: bold;}
        .status-bar.ready { background: #d4edda; color: #155724; }
        .status-bar.loading { background: #fff3cd; color: #856404; }
        .status-bar.error { background: #f8d7da; color: #721c24; }
        
        .chat-box {
            flex: 1; /* Fills remaining space */
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            margin-bottom: 15px;
            background: #f9f9f9;
        }
        
        .message { margin-bottom: 15px; padding: 12px 15px; border-radius: 8px; font-size: 14px; line-height: 1.5; }
        .user-message { background: #667eea; color: white; align-self: flex-end; margin-left: 50px; text-align: right; }
        .ai-message { background: #e0e0e0; color: #333; margin-right: 50px; }
        
        /* --- üìä CHART STYLES --- */
        .chart-container { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-top: 10px; }
        
        /* --- ‚ñ¶ TABLE STYLES (NEW) --- */
        .table-container {
            overflow-x: auto; /* Scroll horizontally if table is wide */
            margin-top: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .chat-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .chat-table th {
            background-color: #667eea;
            color: white;
            text-align: left;
            padding: 10px;
        }
        .chat-table td {
            border-bottom: 1px solid #eee;
            padding: 8px 10px;
            color: #333;
        }
        .chat-table tr:last-child td { border-bottom: none; }
        .chat-table tr:nth-child(even) { background-color: #f8f9fa; }
        
        /* --- INPUT STYLES --- */
        .input-group { display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        button { padding: 12px 25px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:hover { background: #764ba2; }
        button:disabled { background: #ccc; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö Jasneet AI Project</h1>
        
        <div class="status-bar loading" id="statusBar">üîÑ Connecting...</div>
        
        <div class="chat-box" id="chatBox">
            <div class="message ai-message">
                Hello! You can ask me to:<br>
                1. Answer questions üìù<br>
                2. Create Charts üìä (e.g., "Graph duration by task")<br>
                3. Create Tables ‚ñ¶ (e.g., "List all tasks and start dates")
            </div>
        </div>
        
        <div class="input-group">
            <input type="text" id="userInput" placeholder="Type here..." disabled onkeypress="if(event.key === 'Enter') sendMessage()">
            <button id="sendBtn" onclick="sendMessage()" disabled>Send</button>
        </div>
    </div>

    <script>
        const API_URL = "https://aiproject-1-ipxt.onrender.com";

        window.addEventListener("load", checkStatus);

        function checkStatus() {
            fetch(`${API_URL}/api/status`)
                .then(r => r.json())
                .then(d => {
                    const sb = document.getElementById("statusBar");
                    if(d.document_loaded) {
                        sb.className = "status-bar ready"; sb.innerText = "‚úÖ System Ready";
                        toggleInput(true);
                    } else {
                        sb.className = "status-bar error"; sb.innerText = "‚ùå Excel not loaded";
                    }
                })
                .catch(() => {
                    document.getElementById("statusBar").innerText = "‚ùå Offline";
                });
        }

        function toggleInput(enable) {
            document.getElementById("userInput").disabled = !enable;
            document.getElementById("sendBtn").disabled = !enable;
        }

        function sendMessage() {
            const input = document.getElementById("userInput");
            const txt = input.value.trim();
            if(!txt) return;

            addMessage(txt, "user-message");
            input.value = "";
            toggleInput(false);

            const loadId = addMessage("‚è≥ Thinking...", "ai-message");

            fetch(`${API_URL}/api/chat`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt: txt })
            })
            .then(r => r.json())
            .then(data => {
                document.getElementById(loadId).remove();
                
                // 1. Show the Summary Text
                addMessage(data.response, "ai-message");

                // 2. Check for Table
                if(data.type === "table") {
                    renderTable(data.table_data);
                }
                // 3. Check for Chart
                else if(data.type === "chart") {
                    renderChart(data.chart_data);
                }
            })
            .catch(e => {
                document.getElementById(loadId).innerText = "Error: " + e;
            })
            .finally(() => {
                toggleInput(true);
                input.focus();
            });
        }

        // --- ‚ñ¶ RENDER TABLE FUNCTION ---
        function renderTable(tableData) {
            const chatBox = document.getElementById("chatBox");
            const container = document.createElement("div");
            container.className = "table-container";

            let html = `<table class="chat-table"><thead><tr>`;
            
            // Add Headers
            tableData.columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += `</tr></thead><tbody>`;

            // Add Rows
            tableData.rows.forEach(row => {
                html += `<tr>`;
                row.forEach(cell => {
                    html += `<td>${cell}</td>`;
                });
                html += `</tr>`;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
            
            chatBox.appendChild(container);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- üìä RENDER CHART FUNCTION ---
        function renderChart(chartData) {
            const chatBox = document.getElementById("chatBox");
            const div = document.createElement("div");
            div.className = "chart-container";
            
            const canvas = document.createElement("canvas");
            canvas.id = "chart-" + Date.now();
            canvas.style.maxHeight = "300px";
            div.appendChild(canvas);
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;

            new Chart(document.getElementById(canvas.id), {
                type: chartData.chart_type,
                data: {
                    labels: chartData.data.labels,
                    datasets: [{
                        label: chartData.title,
                        data: chartData.data.values,
                        backgroundColor: '#667eea',
                        borderColor: '#5a67d8',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function addMessage(text, cls) {
            const div = document.createElement("div");
            div.className = "message " + cls;
            div.innerHTML = text.replace(/\n/g, "<br>"); // Allow line breaks
            div.id = "msg-" + Date.now();
            document.getElementById("chatBox").appendChild(div);
            document.getElementById("chatBox").scrollTop = document.getElementById("chatBox").scrollHeight;
            return div.id;
        }
    </script>
</body>
</html>
